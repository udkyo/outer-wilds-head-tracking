name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create Release
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: latest
          run-install: false

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          if ($tag -notmatch '^v(\d+\.\d+\.\d+)$') {
            Write-Host "::error::Tag format invalid. Use semantic versioning: v1.2.3"
            exit 1
          }
          $version = $matches[1]
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version"

      - name: Validate version matches manifest
        shell: pwsh
        run: |
          $manifest = Get-Content "manifest.json" -Raw | ConvertFrom-Json
          $manifestVersion = $manifest.version
          $tagVersion = "${{ steps.version.outputs.version }}"

          Write-Host "Manifest version: $manifestVersion"
          Write-Host "Tag version: $tagVersion"

          if ($manifestVersion -ne $tagVersion) {
            Write-Host "::error::Version mismatch! Tag is v$tagVersion but manifest.json has $manifestVersion"
            Write-Host "::error::Update manifest.json to version $tagVersion or use tag v$manifestVersion"
            exit 1
          }

          Write-Host "✅ Version matches!" -ForegroundColor Green

      - name: Validate CHANGELOG entry exists
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"

          if (-not (Test-Path "CHANGELOG.md")) {
            Write-Host "::error::CHANGELOG.md not found"
            exit 1
          }

          $changelog = Get-Content "CHANGELOG.md" -Raw

          # Escape the version for regex (dots are special characters)
          $escapedVersion = [regex]::Escape($version)

          if ($changelog -notmatch "\[?$escapedVersion\]?") {
            Write-Host "::error::CHANGELOG.md missing entry for version $version"
            Write-Host "::error::Add a changelog entry with heading: ## [$version] - $(Get-Date -Format 'yyyy-MM-dd')"
            exit 1
          }

          Write-Host "✅ CHANGELOG.md contains entry for v$version" -ForegroundColor Green

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Download OWML DLLs
        shell: pwsh
        run: |
          Write-Host "Downloading OWML from official release..." -ForegroundColor Cyan

          $owmlVersion = "2.15.4"
          $owmlUrl = "https://github.com/ow-mods/owml/releases/download/$owmlVersion/OWML.zip"
          $owmlZip = "owml-temp.zip"
          # SHA256 hash of OWML 2.15.4 release (for integrity verification)
          $expectedHash = "F95D2D14AEE0ADB60F8DB8DAD2100182433827EDD069A8636284E292F9CBC1D2"

          Invoke-WebRequest -Uri $owmlUrl -OutFile $owmlZip

          # Verify download integrity
          $actualHash = (Get-FileHash -Path $owmlZip -Algorithm SHA256).Hash
          if ($actualHash -ne $expectedHash) {
            Write-Host "::error::OWML download hash mismatch!"
            Write-Host "::error::Expected: $expectedHash"
            Write-Host "::error::Got: $actualHash"
            exit 1
          }

          Write-Host "✅ OWML download verified" -ForegroundColor Green
          Write-Host "Extracting OWML DLLs..." -ForegroundColor Cyan

          # Create libs directory
          New-Item -ItemType Directory -Force -Path "libs" | Out-Null

          # Extract only the DLLs we need
          Expand-Archive -Path $owmlZip -DestinationPath "owml-temp" -Force
          Copy-Item "owml-temp/OWML.Common.dll" "libs/"
          Copy-Item "owml-temp/OWML.ModHelper.dll" "libs/"
          Copy-Item "owml-temp/OWML.ModHelper.Menus.dll" "libs/"

          # Clean up
          Remove-Item $owmlZip
          Remove-Item -Recurse "owml-temp"

          Write-Host "✅ OWML DLLs extracted from verified archive" -ForegroundColor Green

      - name: Restore NuGet packages
        run: dotnet restore

      - name: Build release
        shell: pwsh
        run: |
          Write-Host "Building release..." -ForegroundColor Cyan
          dotnet build HeadTracking.csproj --configuration Release

          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Build failed"
            exit 1
          }

          Write-Host "✅ Build succeeded" -ForegroundColor Green

      - name: Package release
        shell: pwsh
        run: |
          Write-Host "Packaging release..." -ForegroundColor Cyan
          powershell -ExecutionPolicy Bypass -File scripts/package-release.ps1

          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Packaging failed"
            exit 1
          }

          Write-Host "✅ Package created" -ForegroundColor Green

      - name: Extract changelog for this version
        id: changelog
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $changelog = Get-Content "CHANGELOG.md" -Raw

          # Extract section between this version and next heading
          $pattern = "(?s)## \[?$version\]?.*?\n(.*?)(\n## |\z)"
          if ($changelog -match $pattern) {
            $notes = $matches[1].Trim()

            # Save to file for GitHub release
            $notes | Out-File -FilePath "release-notes.txt" -Encoding utf8 -NoNewline

            Write-Host "Extracted changelog:"
            Write-Host $notes
          } else {
            Write-Host "Could not extract changelog section, using default"
            "Release v$version" | Out-File -FilePath "release-notes.txt" -Encoding utf8 -NoNewline
          }

      - name: Find release ZIP
        id: find_zip
        shell: pwsh
        run: |
          $manifest = Get-Content "manifest.json" -Raw | ConvertFrom-Json
          $uniqueName = $manifest.uniqueName
          $version = "${{ steps.version.outputs.version }}"
          $zipPath = "dist/$uniqueName-v$version.zip"

          if (-not (Test-Path $zipPath)) {
            Write-Host "::error::Release ZIP not found at $zipPath"
            exit 1
          }

          echo "zip_path=$zipPath" >> $env:GITHUB_OUTPUT
          echo "zip_name=$uniqueName-v$version.zip" >> $env:GITHUB_OUTPUT

          Write-Host "Found ZIP: $zipPath"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: pwsh
        run: |
          $tag = "${{ steps.version.outputs.tag }}"
          $zipPath = "${{ steps.find_zip.outputs.zip_path }}"
          $zipName = "${{ steps.find_zip.outputs.zip_name }}"

          Write-Host "Creating GitHub Release for $tag..." -ForegroundColor Cyan

          gh release create $tag `
            --title "Head Tracking for Outer Wilds $tag" `
            --notes-file "release-notes.txt" `
            $zipPath

          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Failed to create GitHub release"
            exit 1
          }

          Write-Host "✅ Release created successfully!" -ForegroundColor Green
          Write-Host "   View at: https://github.com/${{ github.repository }}/releases/tag/$tag" -ForegroundColor Cyan
