name: Build

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'

jobs:
  build:
    name: Build and Validate
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: latest
          run-install: false

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Download OWML DLLs
        shell: pwsh
        run: |
          Write-Host "Downloading OWML from official release..." -ForegroundColor Cyan

          $owmlVersion = "2.15.4"
          $owmlUrl = "https://github.com/ow-mods/owml/releases/download/$owmlVersion/OWML.zip"
          $owmlZip = "owml-temp.zip"
          # SHA256 hash of OWML 2.15.4 release (for integrity verification)
          $expectedHash = "F95D2D14AEE0ADB60F8DB8DAD2100182433827EDD069A8636284E292F9CBC1D2"

          Invoke-WebRequest -Uri $owmlUrl -OutFile $owmlZip

          # Verify download integrity
          $actualHash = (Get-FileHash -Path $owmlZip -Algorithm SHA256).Hash
          if ($actualHash -ne $expectedHash) {
            Write-Host "::error::OWML download hash mismatch!"
            Write-Host "::error::Expected: $expectedHash"
            Write-Host "::error::Got: $actualHash"
            exit 1
          }

          Write-Host "✅ OWML download verified" -ForegroundColor Green
          Write-Host "Extracting OWML DLLs..." -ForegroundColor Cyan

          # Create libs directory
          New-Item -ItemType Directory -Force -Path "libs" | Out-Null

          # Extract only the DLLs we need
          Expand-Archive -Path $owmlZip -DestinationPath "owml-temp" -Force
          Copy-Item "owml-temp/OWML.Common.dll" "libs/"
          Copy-Item "owml-temp/OWML.ModHelper.dll" "libs/"
          Copy-Item "owml-temp/OWML.ModHelper.Menus.dll" "libs/"

          # Clean up
          Remove-Item $owmlZip
          Remove-Item -Recurse "owml-temp"

          Write-Host "✅ OWML DLLs extracted from verified archive" -ForegroundColor Green

      - name: Restore NuGet packages
        run: dotnet restore

      - name: Build Debug
        shell: pwsh
        run: |
          Write-Host "Building debug configuration..." -ForegroundColor Cyan
          dotnet build HeadTracking.csproj --configuration Debug

          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Debug build failed"
            exit 1
          }

          Write-Host "✅ Debug build succeeded" -ForegroundColor Green

      - name: Build Release
        shell: pwsh
        run: |
          Write-Host "Building release configuration..." -ForegroundColor Cyan
          dotnet build HeadTracking.csproj --configuration Release

          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Release build failed"
            exit 1
          }

          Write-Host "✅ Release build succeeded" -ForegroundColor Green

      - name: Verify build outputs
        shell: pwsh
        run: |
          Write-Host "Verifying build outputs..." -ForegroundColor Cyan

          $requiredFiles = @(
            "bin/Debug/net48/HeadTracking.dll",
            "bin/Release/net48/HeadTracking.dll"
          )

          $allExist = $true
          foreach ($file in $requiredFiles) {
            if (Test-Path $file) {
              $size = (Get-Item $file).Length / 1KB
              Write-Host "  ✅ $file ($([math]::Round($size, 2)) KB)" -ForegroundColor Green
            } else {
              Write-Host "  ❌ Missing: $file" -ForegroundColor Red
              $allExist = $false
            }
          }

          if (-not $allExist) {
            Write-Host "::error::Some build outputs are missing"
            exit 1
          }

          Write-Host "✅ All build outputs verified" -ForegroundColor Green

      - name: Check for unwanted dependencies in output
        shell: pwsh
        run: |
          Write-Host "Checking for unwanted DLLs in output..." -ForegroundColor Cyan

          $buildPath = "bin/Release/net48"
          $dlls = Get-ChildItem "$buildPath/*.dll" | Where-Object { $_.Name -ne "HeadTracking.dll" }

          if ($dlls) {
            Write-Host "::warning::Found unexpected DLLs in build output:"
            foreach ($dll in $dlls) {
              Write-Host "  ⚠️  $($dll.Name)" -ForegroundColor Yellow
            }
            Write-Host "These will NOT be included in releases (by design)"
          } else {
            Write-Host "✅ No unwanted DLLs in output" -ForegroundColor Green
          }
